import React, { useState, useEffect } from 'react';
import { Check, Plus, X, Edit2, Play, Pause, RotateCcw, Star, Flame, Award } from 'lucide-react';

const KawaiiWorkDashboard = () => {
  const [categories, setCategories] = useState([]);
  const [tasks, setTasks] = useState([]);
  const [pomodoroTime, setPomodoroTime] = useState(25 * 60);
  const [isTimerRunning, setIsTimerRunning] = useState(false);
  const [isBreak, setIsBreak] = useState(false);
  const [completedPomodoros, setCompletedPomodoros] = useState(0);
  const [points, setPoints] = useState(0);
  const [streak, setStreak] = useState(0);
  const [showAddCategory, setShowAddCategory] = useState(false);
  const [showAddTask, setShowAddTask] = useState(false);
  const [showAddLink, setShowAddLink] = useState(null);
  const [editingCategory, setEditingCategory] = useState(null);
  const [taskFilter, setTaskFilter] = useState('all');
  const [celebrationMessage, setCelebrationMessage] = useState('');

  // Load data from storage
  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      const [categoriesResult, tasksResult, statsResult] = await Promise.all([
        window.storage.get('kawaii-categories').catch(() => null),
        window.storage.get('kawaii-tasks').catch(() => null),
        window.storage.get('kawaii-stats').catch(() => null)
      ]);

      if (categoriesResult) setCategories(JSON.parse(categoriesResult.value));
      if (tasksResult) setTasks(JSON.parse(tasksResult.value));
      if (statsResult) {
        const stats = JSON.parse(statsResult.value);
        setPoints(stats.points || 0);
        setStreak(stats.streak || 0);
        setCompletedPomodoros(stats.pomodoros || 0);
      }
    } catch (error) {
      console.error('Error loading data:', error);
    }
  };

  const saveCategories = async (newCategories) => {
    setCategories(newCategories);
    try {
      await window.storage.set('kawaii-categories', JSON.stringify(newCategories));
    } catch (error) {
      console.error('Error saving categories:', error);
    }
  };

  const saveTasks = async (newTasks) => {
    setTasks(newTasks);
    try {
      await window.storage.set('kawaii-tasks', JSON.stringify(newTasks));
    } catch (error) {
      console.error('Error saving tasks:', error);
    }
  };

  const saveStats = async (newPoints, newStreak, newPomodoros) => {
    try {
      await window.storage.set('kawaii-stats', JSON.stringify({
        points: newPoints,
        streak: newStreak,
        pomodoros: newPomodoros
      }));
    } catch (error) {
      console.error('Error saving stats:', error);
    }
  };

  // Timer logic
  useEffect(() => {
    let interval;
    if (isTimerRunning && pomodoroTime > 0) {
      interval = setInterval(() => {
        setPomodoroTime(time => time - 1);
      }, 1000);
    } else if (pomodoroTime === 0) {
      handleTimerComplete();
    }
    return () => clearInterval(interval);
  }, [isTimerRunning, pomodoroTime]);

  const handleTimerComplete = () => {
    setIsTimerRunning(false);
    if (!isBreak) {
      const newPomodoros = completedPomodoros + 1;
      const newPoints = points + 10;
      setCompletedPomodoros(newPomodoros);
      setPoints(newPoints);
      saveStats(newPoints, streak, newPomodoros);
      showCelebration('üçÖ Pomodoro complete! +10 points!');
      setPomodoroTime(5 * 60);
      setIsBreak(true);
    } else {
      showCelebration('‚òï Break time over! Ready to focus?');
      setPomodoroTime(25 * 60);
      setIsBreak(false);
    }
  };

  const toggleTimer = () => setIsTimerRunning(!isTimerRunning);

  const resetTimer = () => {
    setIsTimerRunning(false);
    setPomodoroTime(isBreak ? 5 * 60 : 25 * 60);
  };

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const addCategory = (name) => {
    const newCategory = {
      id: Date.now(),
      name,
      links: []
    };
    saveCategories([...categories, newCategory]);
    setShowAddCategory(false);
  };

  const deleteCategory = (id) => {
    saveCategories(categories.filter(cat => cat.id !== id));
  };

  const updateCategory = (id, newName) => {
    saveCategories(categories.map(cat => 
      cat.id === id ? { ...cat, name: newName } : cat
    ));
    setEditingCategory(null);
  };

  const addLink = (categoryId, name, url) => {
    const newLink = { id: Date.now(), name, url };
    saveCategories(categories.map(cat =>
      cat.id === categoryId ? { ...cat, links: [...cat.links, newLink] } : cat
    ));
    setShowAddLink(null);
  };

  const deleteLink = (categoryId, linkId) => {
    saveCategories(categories.map(cat =>
      cat.id === categoryId 
        ? { ...cat, links: cat.links.filter(link => link.id !== linkId) }
        : cat
    ));
  };

  const addTask = (text, category, priority, dueDate) => {
    const newTask = {
      id: Date.now(),
      text,
      category,
      priority,
      dueDate,
      completed: false,
      createdAt: new Date().toISOString()
    };
    saveTasks([...tasks, newTask]);
    setShowAddTask(false);
  };

  const toggleTask = (id) => {
    const task = tasks.find(t => t.id === id);
    if (!task.completed) {
      const pointsGained = task.priority === 'high' ? 15 : task.priority === 'medium' ? 10 : 5;
      const newPoints = points + pointsGained;
      const newStreak = streak + 1;
      setPoints(newPoints);
      setStreak(newStreak);
      saveStats(newPoints, newStreak, completedPomodoros);
      showCelebration(`‚ú® Task complete! +${pointsGained} points!`);
    }
    saveTasks(tasks.map(t => t.id === id ? { ...t, completed: !t.completed } : t));
  };

  const deleteTask = (id) => {
    saveTasks(tasks.filter(t => t.id !== id));
  };

  const showCelebration = (message) => {
    setCelebrationMessage(message);
    setTimeout(() => setCelebrationMessage(''), 3000);
  };

  const getLevel = () => Math.floor(points / 50) + 1;
  const getProgressToNextLevel = () => (points % 50) / 50 * 100;

  const filteredTasks = taskFilter === 'all' 
    ? tasks 
    : tasks.filter(t => t.category === taskFilter);

  const uniqueCategories = [...new Set(tasks.map(t => t.category))];

  return (
    <div className="min-h-screen bg-gradient-to-br from-pink-100 via-purple-100 to-blue-100 p-6">
      <div className="max-w-7xl mx-auto space-y-6">
        {/* Header */}
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-purple-600 mb-2">üå∏ Kawaii Work Dashboard üå∏</h1>
          <p className="text-purple-400">Stay organized and motivated! ‚ú®</p>
        </div>

        {/* Celebration Message */}
        {celebrationMessage && (
          <div className="fixed top-20 left-1/2 transform -translate-x-1/2 bg-white px-6 py-3 rounded-full shadow-lg border-4 border-pink-300 z-50 animate-bounce">
            <p className="text-lg font-bold text-purple-600">{celebrationMessage}</p>
          </div>
        )}

        {/* Stats Bar */}
        <div className="bg-white rounded-3xl shadow-lg p-6 border-4 border-pink-200">
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div className="text-center">
              <div className="text-3xl mb-2">‚≠ê</div>
              <div className="text-2xl font-bold text-purple-600">{points}</div>
              <div className="text-sm text-gray-500">Total Points</div>
            </div>
            <div className="text-center">
              <div className="text-3xl mb-2">üî•</div>
              <div className="text-2xl font-bold text-orange-500">{streak}</div>
              <div className="text-sm text-gray-500">Task Streak</div>
            </div>
            <div className="text-center">
              <div className="text-3xl mb-2">üçÖ</div>
              <div className="text-2xl font-bold text-red-500">{completedPomodoros}</div>
              <div className="text-sm text-gray-500">Pomodoros</div>
            </div>
            <div className="text-center">
              <div className="text-3xl mb-2">üèÜ</div>
              <div className="text-2xl font-bold text-yellow-500">Level {getLevel()}</div>
              <div className="w-full bg-gray-200 rounded-full h-2 mt-2">
                <div 
                  className="bg-gradient-to-r from-yellow-400 to-pink-400 h-2 rounded-full transition-all"
                  style={{ width: `${getProgressToNextLevel()}%` }}
                />
              </div>
            </div>
          </div>
        </div>

        {/* Pomodoro Timer */}
        <div className="bg-gradient-to-r from-red-100 to-pink-100 rounded-3xl shadow-lg p-6 border-4 border-red-200">
          <h2 className="text-2xl font-bold text-red-600 mb-4 text-center">
            üçÖ Pomodoro Timer
          </h2>
          <div className="text-center">
            <div className="text-6xl font-bold text-red-600 mb-4">{formatTime(pomodoroTime)}</div>
            <div className="text-lg text-red-500 mb-4">{isBreak ? '‚òï Break Time' : 'üí™ Focus Time'}</div>
            <div className="flex gap-3 justify-center">
              <button
                onClick={toggleTimer}
                className="bg-red-500 text-white px-6 py-3 rounded-full font-bold hover:bg-red-600 transition flex items-center gap-2"
              >
                {isTimerRunning ? <Pause size={20} /> : <Play size={20} />}
                {isTimerRunning ? 'Pause' : 'Start'}
              </button>
              <button
                onClick={resetTimer}
                className="bg-white text-red-500 px-6 py-3 rounded-full font-bold hover:bg-red-50 transition flex items-center gap-2 border-2 border-red-500"
              >
                <RotateCcw size={20} />
                Reset
              </button>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Quick Links */}
          <div className="bg-white rounded-3xl shadow-lg p-6 border-4 border-purple-200">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-2xl font-bold text-purple-600">üîó Quick Links</h2>
              <button
                onClick={() => setShowAddCategory(true)}
                className="bg-purple-500 text-white p-2 rounded-full hover:bg-purple-600 transition"
              >
                <Plus size={20} />
              </button>
            </div>

            {showAddCategory && (
              <CategoryForm
                onSubmit={addCategory}
                onCancel={() => setShowAddCategory(false)}
              />
            )}

            <div className="space-y-4">
              {categories.map(category => (
                <div key={category.id} className="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-4 border-2 border-purple-200">
                  <div className="flex justify-between items-center mb-3">
                    {editingCategory === category.id ? (
                      <input
                        type="text"
                        defaultValue={category.name}
                        onBlur={(e) => updateCategory(category.id, e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && updateCategory(category.id, e.target.value)}
                        className="font-bold text-lg text-purple-700 bg-white rounded-lg px-2 py-1 border-2 border-purple-300"
                        autoFocus
                      />
                    ) : (
                      <h3 className="font-bold text-lg text-purple-700">{category.name}</h3>
                    )}
                    <div className="flex gap-2">
                      <button
                        onClick={() => setEditingCategory(category.id)}
                        className="text-purple-500 hover:text-purple-700"
                      >
                        <Edit2 size={16} />
                      </button>
                      <button
                        onClick={() => setShowAddLink(category.id)}
                        className="text-green-500 hover:text-green-700"
                      >
                        <Plus size={16} />
                      </button>
                      <button
                        onClick={() => deleteCategory(category.id)}
                        className="text-red-500 hover:text-red-700"
                      >
                        <X size={16} />
                      </button>
                    </div>
                  </div>

                  {showAddLink === category.id && (
                    <LinkForm
                      onSubmit={(name, url) => addLink(category.id, name, url)}
                      onCancel={() => setShowAddLink(null)}
                    />
                  )}

                  <div className="space-y-2">
                    {category.links.map(link => (
                      <div key={link.id} className="flex justify-between items-center bg-white rounded-lg p-2 border border-purple-200">
                        <a
                          href={link.url}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="text-purple-600 hover:text-purple-800 flex-1"
                        >
                          {link.name}
                        </a>
                        <button
                          onClick={() => deleteLink(category.id, link.id)}
                          className="text-red-400 hover:text-red-600"
                        >
                          <X size={14} />
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Tasks */}
          <div className="bg-white rounded-3xl shadow-lg p-6 border-4 border-blue-200">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-2xl font-bold text-blue-600">‚úÖ Tasks</h2>
              <button
                onClick={() => setShowAddTask(true)}
                className="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition"
              >
                <Plus size={20} />
              </button>
            </div>

            {showAddTask && (
              <TaskForm
                onSubmit={addTask}
                onCancel={() => setShowAddTask(false)}
              />
            )}

            <div className="mb-4">
              <select
                value={taskFilter}
                onChange={(e) => setTaskFilter(e.target.value)}
                className="w-full bg-blue-50 border-2 border-blue-200 rounded-lg px-3 py-2 text-blue-700"
              >
                <option value="all">All Tasks üåà</option>
                {uniqueCategories.map(cat => (
                  <option key={cat} value={cat}>{cat}</option>
                ))}
              </select>
            </div>

            <div className="space-y-3 max-h-96 overflow-y-auto">
              {filteredTasks.map(task => (
                <div
                  key={task.id}
                  className={`rounded-xl p-4 border-2 transition ${
                    task.completed
                      ? 'bg-gray-100 border-gray-300'
                      : task.priority === 'high'
                      ? 'bg-red-50 border-red-300'
                      : task.priority === 'medium'
                      ? 'bg-yellow-50 border-yellow-300'
                      : 'bg-green-50 border-green-300'
                  }`}
                >
                  <div className="flex items-start gap-3">
                    <button
                      onClick={() => toggleTask(task.id)}
                      className={`mt-1 flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition ${
                        task.completed
                          ? 'bg-green-500 border-green-500'
                          : 'bg-white border-gray-300 hover:border-green-500'
                      }`}
                    >
                      {task.completed && <Check size={16} className="text-white" />}
                    </button>
                    <div className="flex-1">
                      <p className={`font-medium ${task.completed ? 'line-through text-gray-500' : 'text-gray-800'}`}>
                        {task.text}
                      </p>
                      <div className="flex gap-2 mt-2 text-xs flex-wrap">
                        <span className="bg-white px-2 py-1 rounded-full">{task.category}</span>
                        <span className={`px-2 py-1 rounded-full ${
                          task.priority === 'high' ? 'bg-red-200 text-red-700' :
                          task.priority === 'medium' ? 'bg-yellow-200 text-yellow-700' :
                          'bg-green-200 text-green-700'
                        }`}>
                          {task.priority}
                        </span>
                        {task.dueDate && (
                          <span className="bg-white px-2 py-1 rounded-full">üìÖ {task.dueDate}</span>
                        )}
                      </div>
                    </div>
                    <button
                      onClick={() => deleteTask(task.id)}
                      className="text-red-400 hover:text-red-600 flex-shrink-0"
                    >
                      <X size={18} />
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

const CategoryForm = ({ onSubmit, onCancel }) => {
  const [name, setName] = useState('');

  const handleSubmit = () => {
    if (name.trim()) {
      onSubmit(name.trim());
      setName('');
    }
  };

  return (
    <div className="mb-4 p-3 bg-purple-50 rounded-lg border-2 border-purple-200">
      <input
        type="text"
        value={name}
        onChange={(e) => setName(e.target.value)}
        onKeyPress={(e) => e.key === 'Enter' && handleSubmit()}
        placeholder="Category name..."
        className="w-full px-3 py-2 rounded-lg border-2 border-purple-300 mb-2"
        autoFocus
      />
      <div className="flex gap-2">
        <button onClick={handleSubmit} className="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 flex-1">
          Add
        </button>
        <button onClick={onCancel} className="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">
          Cancel
        </button>
      </div>
    </div>
  );
};

const LinkForm = ({ onSubmit, onCancel }) => {
  const [name, setName] = useState('');
  const [url, setUrl] = useState('');

  const handleSubmit = () => {
    if (name.trim() && url.trim()) {
      onSubmit(name.trim(), url.trim());
      setName('');
      setUrl('');
    }
  };

  return (
    <div className="mb-3 p-3 bg-white rounded-lg border-2 border-purple-300">
      <input
        type="text"
        value={name}
        onChange={(e) => setName(e.target.value)}
        onKeyPress={(e) => e.key === 'Enter' && document.getElementById('url-input').focus()}
        placeholder="Link name..."
        className="w-full px-3 py-2 rounded-lg border border-purple-200 mb-2"
      />
      <input
        id="url-input"
        type="url"
        value={url}
        onChange={(e) => setUrl(e.target.value)}
        onKeyPress={(e) => e.key === 'Enter' && handleSubmit()}
        placeholder="https://..."
        className="w-full px-3 py-2 rounded-lg border border-purple-200 mb-2"
      />
      <div className="flex gap-2">
        <button onClick={handleSubmit} className="bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 text-sm flex-1">
          Add Link
        </button>
        <button onClick={onCancel} className="bg-gray-300 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-400 text-sm">
          Cancel
        </button>
      </div>
    </div>
  );
};

const TaskForm = ({ onSubmit, onCancel }) => {
  const [text, setText] = useState('');
  const [category, setCategory] = useState('');
  const [priority, setPriority] = useState('medium');
  const [dueDate, setDueDate] = useState('');

  const handleSubmit = () => {
    if (text.trim() && category.trim()) {
      onSubmit(text.trim(), category.trim(), priority, dueDate);
      setText('');
      setCategory('');
      setPriority('medium');
      setDueDate('');
    }
  };

  return (
    <div className="mb-4 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
      <input
        type="text"
        value={text}
        onChange={(e) => setText(e.target.value)}
        onKeyPress={(e) => e.key === 'Enter' && document.getElementById('category-input').focus()}
        placeholder="Task description..."
        className="w-full px-3 py-2 rounded-lg border-2 border-blue-300 mb-2"
        autoFocus
      />
      <input
        id="category-input"
        type="text"
        value={category}
        onChange={(e) => setCategory(e.target.value)}
        onKeyPress={(e) => e.key === 'Enter' && handleSubmit()}
        placeholder="Category (e.g., Job 1, Personal)..."
        className="w-full px-3 py-2 rounded-lg border-2 border-blue-300 mb-2"
      />
      <div className="grid grid-cols-2 gap-2 mb-2">
        <select
          value={priority}
          onChange={(e) => setPriority(e.target.value)}
          className="px-3 py-2 rounded-lg border-2 border-blue-300"
        >
          <option value="low">Low Priority üü¢</option>
          <option value="medium">Medium Priority üü°</option>
          <option value="high">High Priority üî¥</option>
        </select>
        <input
          type="date"
          value={dueDate}
          onChange={(e) => setDueDate(e.target.value)}
          className="px-3 py-2 rounded-lg border-2 border-blue-300"
        />
      </div>
      <div className="flex gap-2">
        <button onClick={handleSubmit} className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex-1">
          Add Task
        </button>
        <button onClick={onCancel} className="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">
          Cancel
        </button>
      </div>
    </div>
  );
};

export default KawaiiWorkDashboard;